{"version":3,"file":"Renderer.js","sourceRoot":"","sources":["../../src/three-components/Renderer.ts"],"names":[],"mappings":"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","sourcesContent":["/* @license\n * Copyright 2019 Google LLC. All Rights Reserved.\n * Licensed under the Apache License, Version 2.0 (the 'License');\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an 'AS IS' BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {ACESFilmicToneMapping, Event, EventDispatcher, GammaEncoding, PCFSoftShadowMap, WebGL1Renderer} from 'three';\nimport {RoughnessMipmapper} from 'three/examples/jsm/utils/RoughnessMipmapper';\n\nimport {USE_OFFSCREEN_CANVAS} from '../constants.js';\nimport {$canvas, $sceneIsReady, $tick, $updateSize, $userInputElement} from '../model-viewer-base.js';\nimport {clamp, isDebugMode, resolveDpr} from '../utilities.js';\n\nimport {ARRenderer} from './ARRenderer.js';\nimport {CachingGLTFLoader} from './CachingGLTFLoader.js';\nimport {Debugger} from './Debugger.js';\nimport {ModelViewerGLTFInstance} from './gltf-instance/ModelViewerGLTFInstance.js';\nimport {ModelScene} from './ModelScene.js';\nimport TextureUtils from './TextureUtils.js';\n\nexport interface RendererOptions {\n  debug?: boolean;\n}\n\nexport interface ContextLostEvent extends Event {\n  type: 'contextlost';\n  sourceEvent: WebGLContextEvent;\n}\n\n// Between 0 and 1: larger means the average responds faster and is less smooth.\nconst DURATION_DECAY = 0.2;\nconst LOW_FRAME_DURATION_MS = 18;\nconst HIGH_FRAME_DURATION_MS = 26;\nconst MAX_AVG_CHANGE_MS = 2;\nconst SCALE_STEP = 0.79;\nconst DEFAULT_MIN_SCALE = 0.5;\n\nexport const $arRenderer = Symbol('arRenderer');\n\nconst $onWebGLContextLost = Symbol('onWebGLContextLost');\nconst $webGLContextLostHandler = Symbol('webGLContextLostHandler');\nconst $singleton = Symbol('singleton');\n\n/**\n * Registers canvases with Canvas2DRenderingContexts and renders them\n * all in the same WebGLRenderingContext, spitting out textures to apply\n * to the canvases. Creates a fullscreen WebGL canvas that is not added\n * to the DOM, and on each frame, renders each registered canvas on a portion\n * of the WebGL canvas, and applies the texture on the registered canvas.\n *\n * In the future, can use ImageBitmapRenderingContext instead of\n * Canvas2DRenderingContext if supported for cheaper transfering of\n * the texture.\n */\nexport class Renderer extends EventDispatcher {\n  static[$singleton] = new Renderer({debug: isDebugMode()});\n\n  static get singleton() {\n    return this[$singleton];\n  }\n\n  static resetSingleton() {\n    this[$singleton].dispose();\n    this[$singleton] = new Renderer({debug: isDebugMode()});\n  }\n\n  public threeRenderer!: WebGL1Renderer;\n  public canvasElement: HTMLCanvasElement;\n  public canvas3D: HTMLCanvasElement|OffscreenCanvas;\n  public textureUtils: TextureUtils|null;\n  public arRenderer: ARRenderer;\n  public roughnessMipmapper: RoughnessMipmapper;\n  public loader = new CachingGLTFLoader(ModelViewerGLTFInstance);\n  public width = 0;\n  public height = 0;\n  public dpr = 1;\n  public minScale = DEFAULT_MIN_SCALE;\n\n  protected debugger: Debugger|null = null;\n  private scenes: Set<ModelScene> = new Set();\n  private multipleScenesVisible = false;\n  private lastTick: number;\n  private scale = 1;\n  private avgFrameDuration =\n      (HIGH_FRAME_DURATION_MS + LOW_FRAME_DURATION_MS) / 2;\n\n  private[$webGLContextLostHandler] = (event: WebGLContextEvent) =>\n      this[$onWebGLContextLost](event);\n\n  get canRender() {\n    return this.threeRenderer != null;\n  }\n\n  get scaleFactor() {\n    return this.scale;\n  }\n\n  constructor(options?: RendererOptions) {\n    super();\n\n    this.dpr = resolveDpr();\n\n    this.canvasElement = document.createElement('canvas');\n    this.canvasElement.id = 'webgl-canvas';\n\n    this.canvas3D = USE_OFFSCREEN_CANVAS ?\n        this.canvasElement.transferControlToOffscreen() :\n        this.canvasElement;\n\n    this.canvas3D.addEventListener(\n        'webglcontextlost', this[$webGLContextLostHandler] as EventListener);\n\n    try {\n      this.threeRenderer = new WebGL1Renderer({\n        canvas: this.canvas3D,\n        alpha: true,\n        antialias: true,\n        powerPreference: 'high-performance' as WebGLPowerPreference,\n        preserveDrawingBuffer: true\n      });\n      this.threeRenderer.autoClear = true;\n      this.threeRenderer.outputEncoding = GammaEncoding;\n      this.threeRenderer.gammaFactor = 2.2;\n      this.threeRenderer.physicallyCorrectLights = true;\n      this.threeRenderer.setPixelRatio(1);  // handle pixel ratio externally\n      this.threeRenderer.shadowMap.enabled = true;\n      this.threeRenderer.shadowMap.type = PCFSoftShadowMap;\n      this.threeRenderer.shadowMap.autoUpdate = false;\n\n      this.debugger =\n          options != null && !!options.debug ? new Debugger(this) : null;\n      this.threeRenderer.debug = {checkShaderErrors: !!this.debugger};\n\n      // ACESFilmicToneMapping appears to be the most \"saturated\",\n      // and similar to Filament's gltf-viewer.\n      this.threeRenderer.toneMapping = ACESFilmicToneMapping;\n    } catch (error) {\n      console.warn(error);\n    }\n\n    this.arRenderer = new ARRenderer(this);\n    this.textureUtils =\n        this.canRender ? new TextureUtils(this.threeRenderer) : null;\n    this.roughnessMipmapper = new RoughnessMipmapper(this.threeRenderer);\n\n    this.updateRendererSize();\n    this.lastTick = performance.now();\n    this.avgFrameDuration = 0;\n  }\n\n  /**\n   * Updates the renderer's size based on the largest scene and any changes to\n   * device pixel ratio.\n   */\n  private updateRendererSize() {\n    const dpr = resolveDpr();\n    if (dpr !== this.dpr) {\n      // If the device pixel ratio has changed due to page zoom, elements\n      // specified by % width do not fire a resize event even though their CSS\n      // pixel dimensions change, so we force them to update their size here.\n      for (const scene of this.scenes) {\n        const {element} = scene;\n        element[$updateSize](element.getBoundingClientRect());\n      }\n    }\n\n    // Make the renderer the size of the largest scene\n    let width = 0;\n    let height = 0;\n    for (const scene of this.scenes) {\n      width = Math.max(width, scene.width);\n      height = Math.max(height, scene.height);\n    }\n\n    if (width === this.width && height === this.height && dpr === this.dpr) {\n      return;\n    }\n    this.width = width;\n    this.height = height;\n    this.dpr = dpr;\n\n    if (this.canRender) {\n      this.threeRenderer.setSize(width * dpr, height * dpr, false);\n    }\n\n    // Expand the canvas size to make up for shrinking the viewport.\n    const widthCSS = width / this.scale;\n    const heightCSS = height / this.scale;\n    // The canvas element must by styled outside of three due to the offscreen\n    // canvas not being directly stylable.\n    this.canvasElement.style.width = `${widthCSS}px`;\n    this.canvasElement.style.height = `${heightCSS}px`;\n\n    // Each scene's canvas must match the renderer size. In general they can be\n    // larger than the element that contains them, but the overflow is hidden\n    // and only the portion that is shown is copied over.\n    for (const scene of this.scenes) {\n      const {canvas} = scene;\n      canvas.width = Math.round(width * dpr);\n      canvas.height = Math.round(height * dpr);\n      canvas.style.width = `${widthCSS}px`;\n      canvas.style.height = `${heightCSS}px`;\n      scene.isDirty = true;\n    }\n  }\n\n  private updateRendererScale() {\n    let {scale} = this;\n    if (this.avgFrameDuration > HIGH_FRAME_DURATION_MS &&\n        scale > this.minScale) {\n      scale *= SCALE_STEP;\n    } else if (this.avgFrameDuration < LOW_FRAME_DURATION_MS && scale < 1) {\n      scale /= SCALE_STEP;\n      scale = Math.min(scale, 1);\n    }\n    scale = Math.max(scale, this.minScale);\n\n    if (scale == this.scale) {\n      return;\n    }\n    this.scale = scale;\n    this.avgFrameDuration =\n        (HIGH_FRAME_DURATION_MS + LOW_FRAME_DURATION_MS) / 2;\n\n    const width = this.width / scale;\n    const height = this.height / scale;\n\n    this.canvasElement.style.width = `${width}px`;\n    this.canvasElement.style.height = `${height}px`;\n    for (const scene of this.scenes) {\n      const {style} = scene.canvas;\n      style.width = `${width}px`;\n      style.height = `${height}px`;\n      scene.isDirty = true;\n    }\n  }\n\n  registerScene(scene: ModelScene) {\n    this.scenes.add(scene);\n    const {canvas} = scene;\n\n    canvas.width = Math.round(this.width * this.dpr);\n    canvas.height = Math.round(this.height * this.dpr);\n\n    canvas.style.width = `${this.width / this.scale}px`;\n    canvas.style.height = `${this.height / this.scale}px`;\n\n    if (this.multipleScenesVisible) {\n      canvas.classList.add('show');\n    }\n    scene.isDirty = true;\n\n    if (this.canRender && this.scenes.size > 0) {\n      this.threeRenderer.setAnimationLoop((time: number) => this.render(time));\n    }\n\n    if (this.debugger != null) {\n      this.debugger.addScene(scene);\n    }\n  }\n\n  unregisterScene(scene: ModelScene) {\n    this.scenes.delete(scene);\n\n    if (this.canRender && this.scenes.size === 0) {\n      (this.threeRenderer.setAnimationLoop as any)(null);\n    }\n\n    if (this.debugger != null) {\n      this.debugger.removeScene(scene);\n    }\n  }\n\n  displayCanvas(scene: ModelScene): HTMLCanvasElement {\n    return this.multipleScenesVisible ? scene.element[$canvas] :\n                                        this.canvasElement;\n  }\n\n  /**\n   * The function enables an optimization, where when there is only a single\n   * <model-viewer> element, we can use the renderer's 3D canvas directly for\n   * display. Otherwise we need to use the element's 2D canvas and copy the\n   * renderer's result into it.\n   */\n  private selectCanvas() {\n    let visibleScenes = 0;\n    let visibleInput = null;\n    for (const scene of this.scenes) {\n      const {element} = scene;\n      if (element.modelIsVisible) {\n        ++visibleScenes;\n        visibleInput = element[$userInputElement];\n      }\n    }\n    const multipleScenesVisible = visibleScenes > 1 || USE_OFFSCREEN_CANVAS;\n    const {canvasElement} = this;\n\n    if (multipleScenesVisible === this.multipleScenesVisible &&\n        (multipleScenesVisible ||\n         canvasElement.parentElement === visibleInput)) {\n      return;\n    }\n    this.multipleScenesVisible = multipleScenesVisible;\n\n    if (multipleScenesVisible) {\n      canvasElement.classList.remove('show');\n    }\n    for (const scene of this.scenes) {\n      const userInputElement = scene.element[$userInputElement];\n      const canvas = scene.element[$canvas];\n      if (multipleScenesVisible) {\n        canvas.classList.add('show');\n        scene.isDirty = true;\n      } else if (userInputElement === visibleInput) {\n        userInputElement.appendChild(canvasElement);\n        canvasElement.classList.add('show');\n        canvas.classList.remove('show');\n        scene.isDirty = true;\n      }\n    }\n  }\n\n  /**\n   * Returns an array version of this.scenes where the non-visible ones are\n   * first. This allows eager scenes to be rendered before they are visible,\n   * without needing the multi-canvas render path.\n   */\n  private orderedScenes(): Array<ModelScene> {\n    const scenes = [];\n    for (const visible of [false, true]) {\n      for (const scene of this.scenes) {\n        if (scene.element.modelIsVisible === visible) {\n          scenes.push(scene);\n        }\n      }\n    }\n    return scenes;\n  }\n\n  get isPresenting(): boolean {\n    return this.arRenderer.isPresenting;\n  }\n\n  /**\n   * This method takes care of updating the element and renderer state based on\n   * the time that has passed since the last rendered frame.\n   */\n  preRender(scene: ModelScene, t: number, delta: number) {\n    const {element, exposure, model} = scene;\n\n    element[$tick](t, delta);\n\n    const exposureIsNumber =\n        typeof exposure === 'number' && !(self as any).isNaN(exposure);\n    this.threeRenderer.toneMappingExposure = exposureIsNumber ? exposure : 1.0;\n\n    if (model.updateShadow()) {\n      this.threeRenderer.shadowMap.needsUpdate = true;\n    }\n  }\n\n  render(t: number) {\n    const delta = t - this.lastTick;\n    this.lastTick = t;\n\n    if (!this.canRender || this.isPresenting) {\n      return;\n    }\n\n    this.avgFrameDuration += clamp(\n        DURATION_DECAY * (delta - this.avgFrameDuration),\n        -MAX_AVG_CHANGE_MS,\n        MAX_AVG_CHANGE_MS);\n\n    this.selectCanvas();\n    this.updateRendererSize();\n    this.updateRendererScale();\n\n    const {dpr, scale} = this;\n\n    for (const scene of this.orderedScenes()) {\n      if (!scene.element[$sceneIsReady]()) {\n        continue;\n      }\n\n      this.preRender(scene, t, delta);\n\n      if (!scene.isDirty) {\n        continue;\n      }\n      scene.isDirty = false;\n\n      if (!scene.element.modelIsVisible && !this.multipleScenesVisible) {\n        // Here we are pre-rendering on the visible canvas, so we must mark the\n        // visible scene dirty to ensure it overwrites us.\n        for (const scene of this.scenes) {\n          if (scene.element.modelIsVisible) {\n            scene.isDirty = true;\n          }\n        }\n      }\n\n      // We avoid using the Three.js PixelRatio and handle it ourselves here so\n      // that we can do proper rounding and avoid white boundary pixels.\n      const width =\n          Math.min(Math.ceil(scene.width * scale * dpr), this.canvas3D.width);\n      const height =\n          Math.min(Math.ceil(scene.height * scale * dpr), this.canvas3D.height);\n\n      // Need to set the render target in order to prevent\n      // clearing the depth from a different buffer\n      this.threeRenderer.setRenderTarget(null);\n      this.threeRenderer.setViewport(\n          0, Math.floor(this.height * dpr) - height, width, height);\n      this.threeRenderer.render(scene, scene.getCamera());\n\n      if (this.multipleScenesVisible) {\n        if (scene.context == null) {\n          scene.createContext();\n        }\n        if (USE_OFFSCREEN_CANVAS) {\n          const contextBitmap = scene.context as ImageBitmapRenderingContext;\n          const bitmap =\n              (this.canvas3D as OffscreenCanvas).transferToImageBitmap();\n          contextBitmap.transferFromImageBitmap(bitmap);\n        } else {\n          const context2D = scene.context as CanvasRenderingContext2D;\n          context2D.clearRect(0, 0, width, height);\n          context2D.drawImage(\n              this.canvas3D, 0, 0, width, height, 0, 0, width, height);\n        }\n      }\n    }\n  }\n\n  dispose() {\n    if (this.textureUtils != null) {\n      this.textureUtils.dispose();\n    }\n\n    if (this.threeRenderer != null) {\n      this.threeRenderer.dispose();\n    }\n\n    this.textureUtils = null;\n    (this as any).threeRenderer = null;\n\n    this.scenes.clear();\n\n    this.canvas3D.removeEventListener(\n        'webglcontextlost', this[$webGLContextLostHandler] as EventListener);\n  }\n\n  [$onWebGLContextLost](event: WebGLContextEvent) {\n    this.dispatchEvent(\n        {type: 'contextlost', sourceEvent: event} as ContextLostEvent);\n  }\n}\n"]}